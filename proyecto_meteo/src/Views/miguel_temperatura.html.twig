{% extends "base.html.twig" %}

{% block content %}
	<div class="container mt-4">
		<h1 class="text-center mb-4">Histórico de Temperatura</h1>

		<div class="row mb-4">
			<div class="col-md-4">
				<div class="card bg-primary text-white text-center shadow h-100">
					<div class="card-body d-flex flex-column">
						<div class="mb-auto">
							<h5 class="card-title">Última Lectura</h5>
							<p class="display-4">{{ ultimaTemperatura.temperatura }}ºC</p>
							<small>{{ ultimaTemperatura.fechaSistema }}</small>
						</div>

						{% if estadisticasEntreFechas %}
							<div class="mt-4 pt-3 border-top border-light">
								<h6 class="card-title">Estadísticas del Filtro</h6>
								<div class="text-start px-3">
									<p class="mb-2">
										<strong>Media:</strong>
										{{ estadisticasEntreFechas.temperatura_media|number_format(2) }}ºC
									</p>
									<p class="mb-2">
										<strong>Máx:</strong>
										<span class="text-warning fw-bold">{{ estadisticasEntreFechas.temperatura_maxima }}ºC</span>
									</p>
									<p class="mb-0">
										<strong>Mín:</strong>
										<span class="text-info fw-bold">{{ estadisticasEntreFechas.temperatura_minima }}ºC</span>
									</p>
								</div>
							</div>
						{% endif %}
					</div>
				</div>
			</div>

			<div class="col-md-8">
				<div class="card shadow-sm h-100">
					<div class="card-body">
						<h5 class="card-title">Filtrar por Fechas</h5>
						<form action="/temperatura" method="GET" class="row g-3">
							<div class="col-md-5">
								<input type="datetime-local" name="fechaInicio" value="{{ fechaInicio }}" class="form-control" required>
							</div>
							<div class="col-md-5">
								<input type="datetime-local" name="fechaFin" value="{{ fechaFin }}" class="form-control" required>
							</div>
							<div class="col-md-2">
								<button type="submit" class="btn btn-success w-100">Filtrar</button>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>


		<div class="card mb-4 shadow-sm">
			<div class="card-body">
				<h5 class="card-title">
					{% if fechaInicio %}
						Temperaturas por Día (Filtrado:
						{{ fechaInicio|date('d/m/Y') }}
						-
						{{ fechaFin|date('d/m/Y') }})
					{% else %}
						Temperaturas de la Semana Actual
					{% endif %}
				</h5>

				<div class="table-responsive">
					<table class="table table-bordered text-center">
						<thead class="table-light">
							<tr>
								{% for dia in temperaturasSemana %}
									<th>
										<div>{{ dia.dia_semana_es }}</div>
										<small class="text-muted">{{ dia.fecha|date('d/m') }}</small>
									</th>
								{% endfor %}
							</tr>
						</thead>
						<tbody>
							<tr>
								{% for dia in temperaturasSemana %}
									<td {% if not dia.tiene_datos %} class="table-secondary" {% endif %}>
										{% if dia.tiene_datos %}
											<div class="fw-bold text-primary fs-5">
												{{ dia.temperatura_media|number_format(1) }}ºC
											</div>
											<small class="d-block">
												<span class="text-danger">↑{{ dia.temperatura_maxima }}º</span>
												<span class="text-primary">↓{{ dia.temperatura_minima }}º</span>
											</small>
											<small class="text-muted">{{ dia.num_lecturas }}
												lecturas</small>
										{% else %}
											<div class="text-muted fst-italic">Sin datos</div>
										{% endif %}
									</td>
								{% endfor %}
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>

		<div class="card mb-4 shadow-sm">
			<div class="card-body">
				<h5 class="card-title">Gráfica ({{ fechaInicio ? 'Filtrado' : 'Últimos 30 días' }})</h5>
				{% if temperaturas30Dias is empty %}
					<div class="alert alert-warning">No hay datos registrados en este periodo para mostrar la gráfica.</div>
				{% endif %}
				<canvas id="tempChart" width="400" height="150"></canvas>
			</div>
		</div>

		<div class="card shadow-sm">
			<div class="card-body">
				<div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
					<table class="table table-hover">
						<thead class="table-dark">
							<tr>
								<th>Fecha</th>
								<th>Temp ºC</th>
								<th>Humedad</th>
							</tr>
						</thead>
						<tbody>
							{% for reg in todasLasTemperaturas %}
								<tr>
									<td>{{ reg.fechaSistema }}</td>
									<td>{{ reg.temperatura }}ºC</td>
									<td>{{ reg.humedad }}%</td>
								</tr>
							{% else %}
								<tr>
									<td colspan="3" class="text-center">No hay registros recientes. Usa el filtro para ver datos antiguos.</td>
								</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script>
		const ctx = document.getElementById('tempChart').getContext('2d');
const datosPHP = {{ temperaturas30Dias|json_encode()|raw }};

new Chart(ctx, {
type: 'line',
data: {
labels: datosPHP.map(i => i.fechaSistema),
datasets: [
{
label: 'Temperatura (ºC)',
data: datosPHP.map(i => i.temperatura),
borderColor: '#28a745',
fill: false
}
]
}
});
	</script>
{% endblock %}
