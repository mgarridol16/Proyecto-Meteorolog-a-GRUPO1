{% extends "base.html.twig" %}

{% block content %}
	<div class="container mt-4">
		<h1 class="text-center mb-4">Histórico de Lluvia Acumulada</h1>

		<div class="row mb-4">
			<div class="col-md-4">
				<div class="card bg-info text-white text-center shadow h-100">
					<div class="card-body d-flex flex-column">
						<div class="mb-auto">
							<h5 class="card-title">Última Lluvia Registrada</h5>
							<p class="display-4">{{ ultimaLluvia.lluvia }}
								<small class="fs-6">mm</small>
							</p>

							{% if estadisticasEntreFechas %}
								<div class="mt-4 pt-3 border-top border-light">
									<h6 class="card-title">Estadísticas del Filtro</h6>
									<div class="text-start px-3">
										<p class="mb-2">
											<strong>Total Acumulada:</strong>
											{{ estadisticasEntreFechas.lluvia_acumulada|number_format(2) }}mm
										</p>
										<p class="mb-2">
											<strong>Media:</strong>
											<span class="text-light fw-bold">{{ estadisticasEntreFechas.lluvia_media|number_format(2) }}mm</span>
										</p>
										<p class="mb-2">
											<strong>Máx:</strong>
											<span class="text-warning fw-bold">{{ estadisticasEntreFechas.lluvia_maxima }}mm</span>
										</p>
										<p class="mb-0">
											<strong>Mín:</strong>
											<span class="text-info fw-bold">{{ estadisticasEntreFechas.lluvia_minima }}mm</span>
										</p>
									</div>
								</div>
							{% endif %}
						</div>
					</div>
				</div>

				<div class="col-md-8">
					<div class="card shadow-sm h-100">
						<div class="card-body">
							<h5 class="card-title">Filtrar por Fechas</h5>
							<form action="/lluviaAcomulada" method="GET" class="row g-3">
								<div class="col-md-5">
									<input type="datetime-local" name="fechaInicio" value="{{ fechaInicio }}" class="form-control" required>
								</div>
								<div class="col-md-5">
									<input type="datetime-local" name="fechaFin" value="{{ fechaFin }}" class="form-control" required>
								</div>
								<div class="col-md-2">
									<button type="submit" class="btn btn-info text-white w-100">Filtrar</button>
								</div>
							</form>
						</div>
					</div>
				</div>
			</div>


			<div class="card mb-4 shadow-sm">
				<div class="card-body">
					<h5 class="card-title">
						{% if fechaInicio %}
							Lluvia Acumulada por Día (Filtrado:
							{{ fechaInicio|date('d/m/Y') }}
							-
							{{ fechaFin|date('d/m/Y') }})
						{% else %}
							Lluvia de la Semana Actual
						{% endif %}
					</h5>

					<div class="table-responsive">
						<table class="table table-bordered text-center">
							<thead class="table-light">
								<tr>
									{% for dia in lluviaSemana %}
										<th>
											<div>{{ dia.dia_semana_es }}</div>
											<small class="text-muted">{{ dia.fecha|date('d/m') }}</small>
										</th>
									{% endfor %}
								</tr>
							</thead>
							<tbody>
								<tr>
									{% for dia in lluviaSemana %}
										<td {% if not dia.tiene_datos %} class="table-secondary" {% endif %}>
											{% if dia.tiene_datos %}
												<div class="fw-bold text-info fs-5">
													{{ dia.lluvia_acumulada|number_format(2) }}
													<small>mm</small>
												</div>
												<small class="d-block">
													<span class="text-danger">↑{{ dia.lluvia_maxima }}mm</span>
													<span class="text-primary">↓{{ dia.lluvia_minima }}mm</span>
												</small>
												<small class="text-muted">{{ dia.num_lecturas }}
													lecturas</small>
											{% else %}
												<div class="text-muted fst-italic">Sin datos</div>
											{% endif %}
										</td>
									{% endfor %}
								</tr>
							</tbody>
						</table>
					</div>
				</div>
			</div>

			<div class="card mb-4 shadow-sm">
				<div class="card-body">
					<h5 class="card-title">Gráfica ({{ fechaInicio ? 'Filtrado' : 'Últimos 30 días' }})</h5>
					{% if lluvias30Dias is empty %}
						<div class="alert alert-warning">No hay datos registrados en este periodo para mostrar la gráfica.</div>
					{% endif %}
					<canvas id="lluviaChart" width="400" height="150"></canvas>
				</div>
			</div>

			<div class="card shadow-sm">
				<div class="card-body">
					<div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
						<table class="table table-hover">
							<thead class="table-dark">
								<tr>
									<th>Fecha</th>
									<th>Lluvia (mm)</th>
									<th>Humedad (%)</th>
								</tr>
							</thead>
							<tbody>
								{% for reg in todasLasLluvias %}
									<tr>
										<td>{{ reg.fechaSistema }}</td>
										<td>
											<strong>{{ reg.lluvia }}</strong>
											mm</td>
										<td>{{ reg.humedad }}%</td>
									</tr>
								{% else %}
									<tr>
										<td colspan="3" class="text-center">No hay registros recientes. Usa el filtro para ver datos antiguos.</td>
									</tr>
								{% endfor %}
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>

		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<script>
			const ctx = document.getElementById('lluviaChart').getContext('2d');
const datosPHP = {{ lluvias30Dias|json_encode()|raw }};

new Chart(ctx, {
type: 'line',
data: {
labels: datosPHP.map(i => i.fechaSistema),
datasets: [
{
label: 'Lluvia Acumulada (mm)',
data: datosPHP.map(i => i.lluvia),
borderColor: '#0dcaf0',
backgroundColor: 'rgba(13, 202, 240, 0.1)',
fill: true,
tension: 0.3
}
]
}
});
		</script>
	{% endblock %}
